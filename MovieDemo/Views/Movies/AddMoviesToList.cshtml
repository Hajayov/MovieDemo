@model IEnumerable<MovieDemo.Models.Movie>
@{
    int listId = ViewBag.ListId;
    List<int> existingIds = ViewBag.ExistingMovieIds;
    var genres = ViewBag.Genres as IEnumerable<MovieDemo.Models.Genre>;
}

@* Added pb-5 to create a "safety zone" at the bottom of the page *@
<div class="container-fluid px-5 mt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a asp-action="ListDetails" asp-route-id="@listId" class="btn btn-outline-secondary rounded-pill shadow-sm">
            <i class="bi bi-arrow-left me-2"></i>Back to @ViewBag.ListName
        </a>
        <div class="text-end">
            <h2 class="text-white mb-0">Add Movies to <span class="text-warning">@ViewBag.ListName</span></h2>
            <small class="text-secondary">Click the plus icon to add movies to your custom collection.</small>
        </div>
    </div>

    @* --- SEARCH & FILTER SECTION --- *@
    <form asp-action="AddMoviesToList" method="get" class="mb-5 bg-dark p-4 rounded-4 shadow-sm border border-secondary">
        <input type="hidden" name="listId" value="@listId" />
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <button type="submit" class="input-group-text bg-black border-secondary text-warning">
                        <i class="bi bi-search"></i>
                    </button>
                    <input type="text" name="search" value="@ViewContext.HttpContext.Request.Query["search"]"
                           class="form-control bg-black border-secondary text-white" placeholder="Search movies or directors...">
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                    @foreach (var genre in genres)
                    {
                        bool isChecked = (ViewContext.HttpContext.Request.Query["selectedGenres"].ToString().Split(',').Contains(genre.Id.ToString()));
                        <div class="genre-pill">
                            <input type="checkbox" name="selectedGenres" value="@genre.Id" id="genre-@genre.Id"
                                   class="btn-check" @(isChecked ? "checked" : "") onchange="this.form.submit()">
                            <label class="btn btn-outline-secondary btn-sm rounded-pill px-3" for="genre-@genre.Id">@genre.Name</label>
                        </div>
                    }
                </div>
            </div>
        </div>
    </form>

    @* --- MOVIE GRID --- *@
    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-4">
        @foreach (var movie in Model)
        {
            bool isAdded = existingIds.Contains(movie.Id);

            @* --- UPDATED IMAGE LOGIC --- *@
            var posterSrc = "";
            if (string.IsNullOrEmpty(movie.PosterUrl))
            {
                posterSrc = "https://via.placeholder.com/342x513?text=No+Image";
            }
            else if (movie.PosterUrl.StartsWith("http"))
            {
                posterSrc = movie.PosterUrl; // External Link
            }
            else if (movie.PosterUrl.Contains(".") || movie.PosterUrl.StartsWith("/"))
            {
                // Local File: Ensure it looks in /images/ folder if it's just a filename
                posterSrc = movie.PosterUrl.StartsWith("/") ? movie.PosterUrl : "/images/" + movie.PosterUrl;
            }
            else
            {
                posterSrc = "https://image.tmdb.org/t/p/w342" + movie.PosterUrl; // TMDB ID
            }

            <div class="col">
                <div class="card h-100 bg-black border-secondary movie-card shadow-sm overflow-hidden">
                    <div class="position-relative overflow-hidden" style="aspect-ratio:2/3;">
                        <img src="@posterSrc"
                             class="card-img-top @(isAdded ? "opacity-25" : "opacity-75")"
                             style="width: 100%; height: 100%; object-fit: cover;" alt="@movie.Title"
                             onerror="this.src='https://via.placeholder.com/342x513?text=Image+Not+Found'">

                        @if (isAdded)
                        {
                            <div class="position-absolute top-50 start-50 translate-middle text-success display-4">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                        }
                    </div>

                    <div class="card-body p-2 text-center d-flex flex-column justify-content-between">
                        <h6 class="text-white text-truncate mb-2" title="@movie.Title">@movie.Title</h6>

                        <button id="btn-@movie.Id"
                                class="btn @(isAdded ? "btn-success disabled" : "btn-warning") btn-sm w-100 rounded-pill fw-bold"
                                onclick="addMovie(this, @listId, @movie.Id)"
                                @(isAdded ? "disabled" : "")>
                            <i class="bi @(isAdded ? "bi-check-lg" : "bi-plus-lg")"></i>
                            @(isAdded ? "In List" : "Add to List")
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .movie-card {
        transition: transform 0.2s, border-color 0.2s;
        border-radius: 12px;
        background: #000;
    }

        .movie-card:hover {
            transform: translateY(-5px);
            border-color: #ffc107 !important;
            z-index: 10;
        }

    .btn-check:checked + .btn-outline-secondary {
        background-color: #ffc107;
        color: #000;
        border-color: #ffc107;
    }

    .input-group-text {
        transition: 0.2s;
        border: 1px solid #333;
    }

        .input-group-text:hover {
            background-color: #ffc107 !important;
            color: black !important;
            cursor: pointer;
        }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function addMovie(btnElement, lId, mId) {
        btnElement.disabled = true;

        $.post('/Movies/AddMovieToListAjax', { listId: lId, movieId: mId }, function(data) {
            if(data.success) {
                btnElement.classList.replace('btn-warning', 'btn-success');
                btnElement.classList.add('disabled');
                btnElement.innerHTML = '<i class="bi bi-check-lg"></i> In List';

                const card = btnElement.closest('.movie-card');
                if(card) {
                    const img = card.querySelector('img');
                    img.classList.replace('opacity-75', 'opacity-25');

                    if (!card.querySelector('.bi-check-circle-fill')) {
                        const checkDiv = document.createElement('div');
                        checkDiv.className = 'position-absolute top-50 start-50 translate-middle text-success display-4';
                        checkDiv.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                        card.querySelector('.position-relative').appendChild(checkDiv);
                    }
                }

                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    background: '#1a1a1a',
                    color: '#fff'
                });
                Toast.fire({ icon: 'success', title: 'Added to collection' });
            } else {
                btnElement.disabled = false;
                alert("Error adding movie.");
            }
        });
    }
</script>