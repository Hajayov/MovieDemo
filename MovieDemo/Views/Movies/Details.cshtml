@model MovieDemo.Models.Movie

@{
    ViewData["Title"] = Model.Title;
    var returnUrl = Context.Request.Query["returnUrl"].ToString();
    int? fromListId = ViewBag.FromListId;

    // Internal scale 1-10
    int userRating = ViewBag.UserRating ?? 0;
    string userComment = ViewBag.UserComment ?? "";
}

<div class="container mt-5 pb-5">
    <div class="row bg-dark text-white rounded-4 shadow-lg overflow-hidden border border-secondary" style="background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);">

        @* --- Poster Section --- *@
        <div class="col-md-5 p-0 position-relative">
            @{
                var posterSrc = string.IsNullOrEmpty(Model.PosterUrl)
                ? "https://via.placeholder.com/500x750?text=No+Poster"
                : (Model.PosterUrl.StartsWith("http") ? Model.PosterUrl : "/images/" + Model.PosterUrl);
            }
            <img src="@posterSrc" class="img-fluid w-100 h-100" style="object-fit: cover; min-height: 700px;" alt="@Model.Title">
            <div class="position-absolute bottom-0 start-0 w-100 p-4" style="background: linear-gradient(transparent, rgba(0,0,0,0.9));">
                @foreach (var genre in Model.Genres)
                {
                    <span class="badge rounded-pill bg-warning text-dark me-1 px-3 py-2 fw-bold" style="font-size: 0.75rem; letter-spacing: 0.5px;">@genre.Name</span>
                }
            </div>
        </div>

        @* --- Content Section --- *@
        <div class="col-md-7 p-5 d-flex flex-column">

            @* Title & Compact Rating Header *@
            <div class="d-flex justify-content-between align-items-start mb-4">
                <h1 class="display-3 fw-bold mb-0" style="letter-spacing: -1px;">@Model.Title</h1>

                <div class="text-end pt-2">
                    <div class="rating-wrapper d-inline-block position-relative fs-4">
                        <div class="stars-background d-flex text-muted opacity-25">
                            @for (int i = 0; i < 5; i++)
                            {
                                <i class="bi bi-star-fill mx-half"></i>
                            }
                        </div>
                        <div id="stars-foreground" class="stars-foreground d-flex text-warning position-absolute top-0 start-0 overflow-hidden" style="width: @(userRating * 10)%;">
                            @for (int i = 0; i < 5; i++)
                            {
                                <i class="bi bi-star-fill mx-half"></i>
                            }
                        </div>
                        <div class="stars-hover-zones d-flex position-absolute top-0 start-0 w-100 h-100">
                            @for (int i = 1; i <= 10; i++)
                            {
                                <div class="hover-zone" onmouseover="hoverRating(@i)" onmouseout="resetRating()" onclick="setRating(@i)"></div>
                            }
                        </div>
                    </div>
                    <div id="rating-display" class="text-warning fw-bold small mt-1 uppercase" style="font-size: 0.65rem;">
                        @(userRating > 0 ? "SAVED SCORE" : "NOT RATED"): @((userRating / 2.0).ToString("0.0")) <span class="text-muted">/ 5.0</span>
                    </div>
                </div>
            </div>

            @* Summary *@
            <p class="fs-5 text-white-50 mb-5" style="line-height: 1.7; font-weight: 300; max-width: 95%;">@Model.Summary</p>

            @* --- INFO ROW --- *@
            <div class="row border-top border-bottom border-secondary border-opacity-10 py-4 mb-5 shadow-sm">
                <div class="col-4">
                    <small class="text-muted d-block uppercase mb-2">Director</small>
                    <span class="fs-4 fw-bold text-info">@Model.Director</span>
                </div>
                <div class="col-4 border-start border-secondary border-opacity-20">
                    <small class="text-muted d-block uppercase mb-2">Released</small>
                    <span class="fs-4 fw-light text-white">@Model.ReleaseDate</span>
                </div>
                <div class="col-4 border-start border-secondary border-opacity-20">
                    <small class="text-muted d-block uppercase mb-2">Runtime</small>
                    <span class="fs-4 fw-light text-white">@Model.Runtime <small class="fs-6 text-muted">min</small></span>
                </div>
            </div>

            @* --- INTERACTIVE REVIEW & FOOTER AREA --- *@
            <div class="mt-auto">
                @* Panel slides up/down based on activeScore *@
                <div id="review-panel" style="max-height: 0; opacity: 0; overflow: hidden; transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);">
                    <div class="p-4 rounded-4 border border-warning border-opacity-10 mb-4" style="background: rgba(255, 193, 7, 0.03);">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-chat-left-text text-warning me-2"></i>
                            <label class="text-muted small uppercase fw-bold" style="letter-spacing: 2px;">Private Critique</label>
                        </div>

                        <textarea id="review-comment" class="form-control bg-black border-secondary text-white mb-0 shadow-none p-3"
                                  rows="3" style="border-radius: 15px; resize: none; border-color: rgba(255,255,255,0.1) !important;"
                                  placeholder="What stood out to you?">@userComment</textarea>
                    </div>
                </div>

                @* Action Buttons Footer *@
                <div class="d-flex gap-3 align-items-stretch">
                    <div id="rating-prompt" class="flex-grow-1 border border-secondary border-opacity-25 rounded-pill d-flex align-items-center justify-content-center text-muted small uppercase fw-bold" style="letter-spacing: 1px; min-height: 60px;">
                        Select a rating to review
                    </div>

                    <button id="save-btn" class="btn btn-warning flex-grow-1 fw-bold rounded-pill py-3 shadow d-none" onclick="sendReview(@Model.Id)">
                        SAVE TO MY NETWORK
                    </button>

                    @if (returnUrl == "Manage")
                    {
                        <a asp-action="Manage" class="btn btn-outline-light px-5 py-3 rounded-pill d-flex align-items-center fw-bold">BACK</a>
                    }
                    else
                    {
                        <a asp-action="IndexM" class="btn btn-outline-secondary px-5 py-3 rounded-pill d-flex align-items-center fw-bold">BACK</a>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let activeScore = @userRating;
    const foreground = document.getElementById('stars-foreground');
    const display = document.getElementById('rating-display');
    const reviewPanel = document.getElementById('review-panel');
    const commentBox = document.getElementById('review-comment');
    const saveBtn = document.getElementById('save-btn');
    const ratingPrompt = document.getElementById('rating-prompt');

    const scorePhrases = {
        1: "Total disaster", 2: "Deeply flawed", 3: "Underwhelming", 4: "Forgettable",
        5: "It was okay", 6: "Decent watch", 7: "Highly enjoyable", 8: "Great Cinema",
        9: "Near Perfect", 10: "Masterpiece"
    };

    window.addEventListener('DOMContentLoaded', () => {
        if (activeScore > 0) revealPanel(false);
    });

    function revealPanel(shouldFocus) {
        reviewPanel.style.maxHeight = "500px";
        reviewPanel.style.opacity = "1";
        ratingPrompt.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        if(shouldFocus) setTimeout(() => commentBox.focus(), 500);
    }

    function hidePanel() {
        reviewPanel.style.maxHeight = "0";
        reviewPanel.style.opacity = "0";
        ratingPrompt.classList.remove('d-none');
        saveBtn.classList.add('d-none');
    }

    function hoverRating(val) {
        foreground.style.width = (val * 10) + '%';
        foreground.classList.add('ghosting');
        display.innerHTML = `${scorePhrases[val].toUpperCase()}: ${(val / 2.0).toFixed(1)} <span class="text-muted">/ 5.0</span>`;
    }

    function resetRating() {
        foreground.style.width = (activeScore * 10) + '%';
        foreground.classList.remove('ghosting');
        let status = activeScore > 0 ? "SAVED SCORE" : "NOT RATED";
        display.innerHTML = `${status}: ${(activeScore / 2.0).toFixed(1)} <span class="text-muted">/ 5.0</span>`;
    }

    function setRating(val) {
        // TOGGLE LOGIC: If same score is clicked, reset to 0
        if (val === activeScore) {
            activeScore = 0;
            hidePanel();
            foreground.animate([{ opacity: 1 }, { opacity: 0 }, { opacity: 1 }], { duration: 300 });
        } else {
            activeScore = val;
            revealPanel(true);
            commentBox.placeholder = `You gave it a ${(val/2.0)}. What stood out?`;
        }
        resetRating();
    }

    function sendReview(movieId) {
        const commentText = commentBox.value;
        $.post('/Movies/SubmitReview', { movieId: movieId, rating: activeScore, comment: commentText }, function(res) {
            if (res.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'CRITIQUE SAVED',
                    background: '#111',
                    color: '#ffc107',
                    timer: 1500,
                    showConfirmButton: false,
                    customClass: { popup: 'rounded-4 border border-warning shadow-lg' }
                });
            }
        });
    }
</script>

<style>
    body {
        background-color: #050505;
    }

    .uppercase {
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.65rem;
        font-weight: 700;
    }

    .mx-half {
        margin-left: 2px;
        margin-right: 2px;
    }

    .rating-wrapper {
        cursor: pointer;
        user-select: none;
        transition: transform 0.2s;
    }

        .rating-wrapper:hover {
            transform: translateY(-3px);
        }

    .stars-foreground {
        white-space: nowrap;
        transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: none;
    }

        .stars-foreground.ghosting {
            opacity: 0.6;
        }

    .hover-zone {
        flex: 1;
        height: 100%;
        z-index: 10;
    }

    .text-white-50 {
        color: rgba(255, 255, 255, 0.55) !important;
    }

    .form-control:focus {
        background-color: #000 !important;
        border-color: #ffc107 !important;
        color: #fff !important;
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.1) !important;
    }

    .display-3 {
        font-size: 3.5rem;
    }
</style>